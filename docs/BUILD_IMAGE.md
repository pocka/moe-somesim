# 画像生成マニュアル

- [そめしむ用画像生成ツール](https://pocka.github.io/moe-somesim/builder/)
- [画像を横につなげるだけのツール](https://pocka.github.io/moe-somesim/image-concat/)

そめしむは MoE のゲーム内で 2 種類の染色液で染色した装備のスクリーンショットそれぞれ 1 枚ずつ、計 2 枚からシミュレータ用の画像を生成しています。
そめしむ用の画像を生成するための手順は以下のようになっています。

1. 染色液 A で装備を染色する
2. キャラクターに装備させて画面を動画でキャプチャする (動画 A)
3. 染色液 B で装備を染色する
4. キャラクターに装備させて画面を動画でキャプチャする (動画 B)
5. そめしむ内にある画像生成ツールを使って画像を生成する
   1. 動画 A をツールに渡す
   2. 動画内のどのフレームを切り出すか指定する
   3. そめしむ用の画像として切り出す領域を指定する
   4. 動画 B をツールに渡す
   5. 動画 A の指定したフレームとの差分が最も少ない動画 B のフレームを指定する (染色部分以外が全く同じフレームを探す)
   6. 染色液 A と染色液 B の色をツール上で入力する
   7. ツールが出力した画像をダウンロードする

画像生成ツールはステップ形式になっており特に注意する点はありません。
そのため、特に重要になってくるのは「どんな色で染めるか」「どうやって動画を撮るか」の 2 点になります。

## 染める色の選択

そめしむの画像生成では染色前後の変化率を使って染色領域の判別と染色係数（どのくらい染色液の色を利用するか、という数値）を算出しています。
そのため、染色液 A と染色液 B が似たような色の場合ノイズが出たり、関係ないところにもうっすらと色が乗ってしまうことが出てきます。
逆に 2 つの染色液のコントラストが高い場合はノイズの出にくいくっきりとした画像が生成しやすくなります。

経験則的にはミーチチン・ラーファン・フィーヌイの中の暗めの花びらで作った染色液と、イーラッカの薄めの色で作った染色液だとうまくいきやすいです。
色の差が思ったように出せない場合は（お金がかかってしまいますが）薄い方の染色液で染めた後に強力な漂白を行うと結果はよくなりやすいです。

## 動画の撮り方

2 つの画像をプログラムで比較するため、染色部分以外は（ほぼ）ピクセル単位で一致しているフレームが 2 つの動画に存在している必要があります。
以下はそれを踏まえた上でのキャプチャする際のコツです。

### キャラクター選択画面で撮影する

ゲーム内だとゲーム時間によって太陽の位置や色が変わるため、「同じ時間かつ同じアニメーション再生状態」で動画をキャプチャする必要が出てきます。

キャラクター選択画面は常に光源が一定で、キャラクターの待機モーションも発生しないため簡単に近似フレームを含んだ動画をキャプチャすることができます。
ただし、装備固有のモーションなどがある場合（例: こたつ）はゲーム内での撮影が必要になるかもしれません。

キャラクター選択画面でキャプチャする際には、一度キャラクターが表示されたら別のキャラクタに切り替え、再度撮影対象のキャラクターに切り替えることで読み込みとニュートラルアニメーションのずれをなくすことができます。

### 低圧縮・高フレームレートで撮影する

動画の圧縮率を上げるとエンコードノイズ・アーティファクトが発生して染色部分以外にも色が乗ってしまうことがあります（コーデックにもよりますがある程度以上では基本的に発生します）。
GPU で動くキャプチャソフトが使える場合はそれがおすすめです（既存のそめしむの画像は Geforce ShadowPlay でキャプチャした動画から生成しています）。

また同じフレームが必要になる都合上、ディスプレイで利用しているフレームレートそのままでキャプチャすることをおすすめします（大抵の場合は 60fps）。
